{{extend 'layout.html'}}

<link href="{{=URL('static', 'css/game.css')}}" rel="stylesheet" type="text/css"/>
<link href="{{=URL('static', 'css/switch.css')}}" rel="stylesheet" type="text/css"/>
{{if 'message' in globals():}}
<h2>{{=message}}</h2>
{{pass}}


<label class="switch switch-yes-no">
    <input class="switch-input" type="checkbox"/>
    <span class="switch-label" data-on="Yes" data-off="No"></span>
    <span class="switch-handle"></span>
</label>


<head>
    <title>Pythoggle</title>
    <link rel="stylesheet" href="../../static/css/game.css">
    <script type="text/javascript" src='seedrandom.js'></script>
    <script type="text/javascript" src='words.js'></script>
    <script type="text/javascript">

        current_word = "";
        list_of_words = [];
        color_light_yellow = "#f9ff60";
        color_light_grey = "#b8aeba";
        color_orange = "#ffaa00";
        game_in_progress = false;
        dimension = 4;
        bar_width = 368;
        last_pressed_down = "";

        //2 minutes in millis
        total_time = 120 * 1000;
        time_remaining = 0;
        update_frequency = 50;
        timer_var = null;
        board = [];
        board.length = dimension * dimension;
        dice =
                ["yqyswf",
                "xolrql",
                "jkhhwf",
                "ioeoau",
                "qbrlpr",
                "oaaeeu",
                "ggnetn",
                "eiaeao",
                "uieeoo",
                "hcthjt",
                "sztllp",
                "aaeouo",
                "scywsj",
                "ioeuee",
                "aioeea",
                "cmhkzn",
                "hgbmgn",
                "ouoaei",
                "sysyfd",
                "mlgmcp",
                "dbxvdy",
                "fnrddw",
                "vmrgzr",
                "dkxmpk",
                "bvtnts"];





        

        function color_cell(cell) {
             document.getElementById(cell).style.backgroundColor = color_light_yellow;
             last_pressed_down = cell;
        }


        function can_be_pressed_down(cell) {
            if (current_word.length == 0) {
                return true;
            }

            var cell_dimensions = last_pressed_down.split("_");
            var cell_x = parseInt(cell_dimensions[0]);
            var cell_y = parseInt(cell_dimensions[1]);

            possible_cells = [];

            //check each viable position combination
            for (x = 0; x < dimension; x++){
                for (y = 0; y < dimension; y++) {
                    if (x <= cell_x + 1 && x >= cell_x - 1) {
                        if (y <= cell_y + 1 && y >= cell_y - 1) {
                            possible_cells.push(x + "_" + y);
                        }
                    }
                }
            }

            //now, check if our passed cell exists in possible_cells
            return possible_cells.indexOf(cell) > -1;


        }

        function clear_word_and_board() {
//            current_word = [];
            current_word = "";

            //for every square in the board, clear the color
            for (x = 0; x < dimension; x++){
                for (y = 0; y < dimension; y++) {
                    var cell = x + "_" + y;
                    document.getElementById(cell).style.backgroundColor = color_light_grey;
                    document.getElementById("current_word").innerHTML = "";
                }
            }
        }

        function end_game() {
            time_remaining = 0;
            document.getElementById('game_table').style.backgroundColor = color_orange;
            game_in_progress = false;

            //TODO: submit the words to the web2py code that these words are what this player submitted.
            //TODO: also calculate score here? maybe just in python code
        }


        function submit_current_word() {
//            var word_string = get_current_word_string();
            var word_string = current_word;
//            alert("Submitting word: " + word_string);

            //check to see if the current word is in the english dictionary.
            //if so, clear the board and current word, add to submitted words list, and return true
            var w = words;
            if (words.indexOf(word_string) > -1) {
                alert("VALID WORD!");
                list_of_words.push(word_string);
                clear_word_and_board();
                return true;
            }
            return false;
        }

        function letter_selected(event) {
            var cell = event.currentTarget.offsetParent.id;
            var letter = event.currentTarget.textContent;

            if (current_word.length < 1) {
                last_pressed_down = cell;
            }

            if (can_be_pressed_down(cell)) {
                document.getElementById(cell).style.backgroundColor = color_light_yellow;
                color_cell(cell);
                current_word = current_word + letter;
                document.getElementById("current_word").innerHTML = current_word;
            }
        }

        function make_table(first_time) {
            var table_string = '<table id="game_table" width="100%">';
            var x, y;
            for (x = 0; x < dimension; x++){
                table_string = table_string + '<tr>';
                for (y = 0; y < dimension; y++) {
                    table_string = table_string + '<td id="' + y + '_' + x + '" width="' + 250 / dimension + 'px"> </td>';
                }
                table_string = table_string + '</tr>';
            }
            table_string = table_string + '</table>';
            if (first_time) {
                document.writeln(table_string);
            } else {
                document.getElementById('board_div').innerHTML = table_string;
            }
        }

        function update_table() {
            var x, y;
            for (x = 0; x < dimension; x++)  // here? 2
            {
                for (y = 0; y < dimension; y++) {
                    var character = board[x + y * dimension].toUpperCase();
                    if (character == 'Q') character = 'Qu';
                    var cell_id = x + '_' + y;
                    document.getElementById(cell_id).innerHTML = "<a onclick=\"letter_selected(event)\">" + character + "</b>";
                }
            }
        }

        function roll_dice() {
            var i, j;
            for (i = 0; i < dimension * dimension; i++) {
                j = Math.floor(Math.random() * dice.length);
                var die = dice[j];
                j = Math.floor(Math.random() * 6);
                board[i] = die.charAt(j);
            }
        }



        //TODO: clean up, refactor these methods more.
        function new_game() {
            game_in_progress = true;
            current_word = "";
            last_pressed_down = "";
            list_of_words = [];
            roll_dice();
            make_table(false);
            update_table();
            var tt = document.getElementById('total_time');
            if (tt) {
                total_time = parseInt(tt.value) * 1000;
            }
            var sol = document.getElementById('solution');
            if (sol) sol.innerHTML = '';
            if (time_remaining > 0)
                clearTimeout(timer_var);
            time_remaining = total_time;
            timer_var = setTimeout("tick()", update_frequency);
            //set background color of game_table to light blue
            document.getElementById('game_table').style.backgroundColor = color_light_grey;
        }

        function tick() {
            time_remaining = time_remaining - update_frequency;
            if (time_remaining <= 0) {
                //timer has ended, initiate end game logic
                end_game()
            } else {
                timer_var = setTimeout('tick()', update_frequency);
            }
            var t = Math.ceil(time_remaining / 1000);
            document.getElementById('time_remaining').innerHTML = "Remaining time: " + t;
            var w = Math.floor(bar_width * time_remaining / total_time);
            document.getElementById('bar_remaining').width = w;
            document.getElementById('bar_elapsed').width = bar_width - w;
        }

        function transform_word(word) {
            var w = word.toUpperCase();
            return w.replace(/Q/g, 'Qu');
        }

    </script>
</head>
<body>
<table>
    <tr>
        <td valign="top">
            <div id="board_div">
                <script language='javascript'>
                    make_table(true);
                </script>
            </div>
            <table width=368 cellpadding=0 cellspacing=0 id="time_table">
                <tr>
                    <td id='bar_remaining' width=218 height=25></td>
                    <td id='bar_elapsed' width=150 height=25></td>
            </table>
            <div id="current_word" style="margin-bottom: 10px;">

            </div>
             <div id="words_so_far" style="margin-bottom: 10px;">
                []
            </div>
            <div style="margin-bottom: 10px;">
                <form id="submit_button">
                    <input type="button" value="Submit Word" onclick='submit_current_word()'>
                </form>
                <form id="clear_button">
                    <input type="button" value="Clear Word" onclick='clear_word_and_board()'>
                </form>
            </div>
            <div id="time_remaining" style="margin-bottom:10px; margin-top: 10px;">
                Time remaining: ...
            </div>
            <form>
                <div style="margin-bottom: 10px;">
                    <input type="button" value="New game" onclick='new_game()'>
                    Timer:
                </div>
            </form>
        </td>
        <td width=20>&nbsp;</td>
        <td width="100%" valign="top">
            <div id="solution">&nbsp;</div>
        </td>
    </tr>
</table>
</body>

